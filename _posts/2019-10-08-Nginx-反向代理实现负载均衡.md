---
layout: post
title:  "Nginx-反向代理实现负载均衡"
date:   2019-10-08 10:00:00 +0800
categories: 博客
tags: nginx
excerpt: "Nginx实现负载均衡的方式以及几种负载均衡算法简介"
---

## 1、代理
+ 正向代理：Nginx代替客户端发送请求，到目标服务器，例如翻墙
+ 反向代理：Nginx代替服务端接受请求，接受客户端的请求
+ 反向代理流程：
    + 用户通过域名发出访问Web服务器的请求，该域名被DNS服务器解析为反向代理服务器的IP地址；
    + 反向代理服务器接受用户的请求；
    + 反向代理服务器在本地缓存中查找请求的内容，找到后直接把内容发送给用户；
    + 如果本地缓存里没有用户所请求的信息内容，反向代理服务器会代替用户向源服务器请求同样的信息内容，并把信息内容发给用户，如果信息内容是缓存的还会把它保存到缓存中
+ 反向代理优点：
    + 保护了真实的WEB服务器，保证了WEB资源的安全性
    + 节约了有限的IP资源
    + 减少WEB服务器的压力，提高响应速度
    + 请求的统一控制，包括设置权限、过滤规则等；
    + 区分动态和静态可缓存内容；
    + 实现负载均衡，内部可以采用多台服务器来组成服务器集群，外部还是可以采用一个地址访问；
    + 解决Ajax跨域问题；
    + 作为真实服务器的缓冲，解决瞬间负载量大的问题； 

## 2、负载均衡
+ 原理：将服务器接收到的请求按照规则分发的过程，称为负载均衡
+ 类别：负载均衡在实际项目操作过程中，有硬件负载均衡和软件负载均衡两种，硬件负载均衡也称为硬负载，如F5负载均衡，相对造价昂贵成本较高，但是数据的稳定性安全性等等有非常好的保障；更多的公司考虑到成本原因，会选择使用软件负载均衡，软件负载均衡是利用现有的技术结合主机硬件实现的一种消息队列分发机制
+ nginx支持的负载均衡调度算法：
    + round robin（默认）：
        + 轮询方式，依次将请求分配到各个后台服务器中，默认的负载均衡方式。 
        + 适用于后台机器性能一致的情况。 
        + 挂掉的机器可以自动从服务列表中剔除。
    + weight：
        + 这种方式下，可以给不同的后端服务器设置一个权重值（weight），用于调整不同的服务器上请求的分配率；权重数据越大，被分配到请求的几率越大；
        + 该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的。
        + 例如：
        ```sh
        upstream bakend {    
            server 192.168.240.4 weight=1;    
            server 192.168.240.5 weight=2;    
        } 
        ``` 
    + ip_hash：
        + 每个请求按照发起客户端的ip的hash结果进行匹配，这样的算法下一个固定ip地址的客户端总会访问到同一个后端服务器，这也在一定程度上解决了集群部署环境下session共享的问题。
        + 例如：
        ```sh
        upstream bakend {    
            ip_hash;    
            server 192.168.240.4;    
            server 192.168.240.5;    
        }  
        ```
    + fair：
        + 智能调整调度算法，动态的根据后端服务器的请求处理到响应的时间进行均衡分配，响应时间短处理效率高的服务器分配到请求的概率高，响应时间长处理效率低的服务器分配到的请求少；
        + 结合了前两者的优点的一种调度算法。但是需要注意的是nginx默认不支持fair算法，如果要使用这种调度算法，请安装upstream_fair模块
        + 例如：
        ```sh
        upstream backend {      
            fair;    
            server 192.168.240.4;    
            server 192.168.240.5; 
        }
        ```
    + url_hash：
        + 按照访问的url的hash结果分配请求，每个请求的url会指向后端固定的某个服务器，可以在nginx作为静态服务器的情况下提高缓存效率。
        + 同样要注意nginx默认不支持这种调度算法，要使用的话需要安装nginx的hash软件包  
        + 例如：
        ```sh
        upstream bakend {
            hash $request_uri;
            server 192.168.240.4;    
            server 192.168.240.5;
        }
        ```

## 3、负载均衡实现
![]({{site.url}}/assets/20191008_01/0.png){:width="100%"} 
+ 以round robin（默认）方式为例：  
+ 环境准备：
    + nginx服务器：192.168.240.3:80
    + Tomcat服务器1：192.168.240.4:8080
    + Tomcat服务器2：192.168.240.5:8080
+ 配置Nginx配置文件：
```sh
...
upstream bakend {
    // 不配置表示，默认负载均衡调度算法

    // 配置需要分发的Tomcat服务器这里是两台
    server 192.168.240.4:8080;
    server 192.168.240.5:8080;
}
server {
    ...
    location / {
        ...
        // 指定上面配置的负载均衡地址与策略
        proxy_pass http://bakend;
        root   html;
        index  index.html index.htm;
    }
}
``` 
+ 在Tomcat1/2的ROOT目录下分别添加文件：a.html，为了方便测试，a.html里面的内容可以写不同的东西，以便我们能知道我们的请求具体分配到了哪一台Tomcat 
    + Tomcat1：
        ```sh
        <html>
            <h2>这是Tomcat1</h2>
        </html>
    ```

    + Tomcat2
        ```sh
        <html>
            <h2>这是Tomcat2</h2>
        </html>
        ```
+ 每个服务器开放各自所需的端口号
+ 分别启动Tomcat1、Tomcat2、Nginx 
+ 请求：192.168.240.3:80/a.html，结果：
```sh
第一次请求：这是Tomcat1
第二次请求：这是Tomcat2
第一次请求：这是Tomcat1
...
```       
